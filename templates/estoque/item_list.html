{% extends 'base.html' %}
{% block title %}Itens - Almoxarifado{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="mb-0">Itens do almoxarifado</h4>
    <small class="text-muted">Controle e estoque atual por local</small>
  </div>
  <a class="btn btn-primary btn-icon" href="{% url 'item_create' %}">
    <i class="bi bi-plus-circle"></i> Novo item
  </a>
</div>

<div class="card shadow-sm border-0 mb-3">
  <div class="card-body">
    <form class="row g-2" method="get">
      <div class="col-md-6">
        <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Buscar por código, descrição, unidade...">
      </div>
      <div class="col-md-4">
        <select name="fornecedor" class="form-select">
          <option value="">Fornecedor (todos)</option>
          {% for forn in fornecedores %}
            <option value="{{ forn.id }}" {% if fornecedor_id|default:'' == forn.id|stringformat:'s' %}selected{% endif %}>{{ forn.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2 d-grid">
        <button class="btn btn-outline-primary" type="submit"><i class="bi bi-search"></i> Buscar</button>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm border-0">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table align-middle table-hover">
        <thead class="table-light">
          <tr>
            <th>Código</th>
            <th>Descrição</th>
            <th>UM</th>
            <th>Fornecedor</th>
            <th>Valor unit.</th>
            <th>Qtd. total</th>
            <th>Mín/Máx</th>
            <th>Ativo</th>
            <th class="text-end">Ações</th>
          </tr>
        </thead>
        <tbody>
          {% for item in itens %}
          <tr>
            <td class="fw-semibold">{{ item.codigo }}</td>
            <td>{{ item.descricao }}</td>
            <td>{{ item.unidade_medida }}</td>
            <td>{{ item.fornecedor|default:"-" }}</td>
            <td>R$ {{ item.valor_unitario }}</td>
            <td>
              {% if item.total_qtde <= item.estoque_minimo %}
                <span class="badge bg-danger">{{ item.total_qtde }}</span>
              {% elif item.estoque_maximo and item.total_qtde >= item.estoque_maximo %}
                <span class="badge bg-warning text-dark">{{ item.total_qtde }}</span>
              {% else %}
                <span class="badge bg-success">{{ item.total_qtde }}</span>
              {% endif %}
            </td>
            <td>{{ item.estoque_minimo }} / {{ item.estoque_maximo }}</td>
            <td>
              {% if item.ativo %}
                <span class="badge bg-primary">Ativo</span>
              {% else %}
                <span class="badge bg-secondary">Inativo</span>
              {% endif %}
            </td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'item_edit' item.pk %}">
                <i class="bi bi-pencil-square"></i> Editar
              </a>
            </td>
          </tr>
          {% empty %}
          <tr><td colspan="9" class="text-center text-muted py-3">Nenhum item cadastrado.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  (function() {
    const qInput = document.querySelector('input[name="q"]');
    const fornSelect = document.querySelector('select[name="fornecedor"]');
    const storedQ = localStorage.getItem('filtro_itens_q');
    const storedF = localStorage.getItem('filtro_itens_fornecedor');
    if (!qInput.value && storedQ) qInput.value = storedQ;
    if (!fornSelect.value && storedF) fornSelect.value = storedF;
    document.querySelector('form').addEventListener('submit', () => {
      localStorage.setItem('filtro_itens_q', qInput.value);
      localStorage.setItem('filtro_itens_fornecedor', fornSelect.value);
    });
  })();
</script>
{% endblock %}
