{% extends 'base.html' %}
{% block title %}Dashboard - Almoxarifado{% endblock %}
{% block content %}
<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted mb-1">Itens cadastrados</p>
            <h3 class="fw-bold mb-0">{{ total_itens }}</h3>
          </div>
          <span class="icon-circle"><i class="bi bi-box"></i></span>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted mb-1">Valor total estimado</p>
            <h3 class="fw-bold mb-0">R$ {{ valor_total|default:"0.00"|floatformat:2 }}</h3>
          </div>
          <span class="icon-circle"><i class="bi bi-currency-dollar"></i></span>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted mb-1">Movimentações recentes</p>
            <h3 class="fw-bold mb-0">{{ ultimas_movimentacoes|length }}</h3>
          </div>
          <span class="icon-circle"><i class="bi bi-arrow-left-right"></i></span>
        </div>
        <div class="mt-3 d-flex gap-2">
          <a class="btn btn-sm btn-success" href="{% url 'movimentacao_create' %}?tipo=ENTRADA"><i class="bi bi-box-arrow-in-down"></i> Nova entrada</a>
          <a class="btn btn-sm btn-danger" href="{% url 'movimentacao_create' %}?tipo=SAIDA"><i class="bi bi-box-arrow-up"></i> Nova saída</a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-5">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Estoques críticos</h5>
          <span class="badge bg-danger">{{ criticos|length }}</span>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>Item</th>
                <th>Estoque</th>
                <th>Qtd</th>
                <th>Mínimo</th>
              </tr>
            </thead>
            <tbody>
              {% for ie in criticos %}
              <tr>
                <td>
                  <a href="{% url 'item_list' %}?q={{ ie.item.codigo }}" class="text-decoration-none">
                    {{ ie.item.descricao }}
                  </a>
                </td>
                <td>{{ ie.estoque.localizacao }}</td>
                <td><span class="badge bg-danger">{{ ie.qtde }}</span></td>
                <td>{{ ie.estoque.nivel_minimo }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="4" class="text-muted text-center py-3">Nenhum item crítico no momento.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-7">
    <div class="card shadow-sm border-0 h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Últimas movimentações</h5>
          <a class="btn btn-outline-primary btn-sm" href="{% url 'movimentacao_list' %}">Ver todas</a>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>Data</th>
                <th>Tipo</th>
                <th>Item</th>
                <th>Estoque</th>
                <th>Qtd</th>
              </tr>
            </thead>
            <tbody>
              {% for mov in ultimas_movimentacoes %}
              <tr>
                <td>{{ mov.data_movimentacao|date:"d/m H:i" }}</td>
                <td>
                  {% if mov.tipo_movimentacao == 'ENTRADA' %}
                    <span class="badge bg-success">{{ mov.get_tipo_movimentacao_display }}</span>
                  {% elif mov.tipo_movimentacao == 'SAIDA' %}
                    <span class="badge bg-danger">{{ mov.get_tipo_movimentacao_display }}</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ mov.get_tipo_movimentacao_display }}</span>
                  {% endif %}
                </td>
                <td>{{ mov.item.descricao }}</td>
                <td>{{ mov.estoque.localizacao }}</td>
                <td>{{ mov.quantidade }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="5" class="text-muted text-center py-3">Nenhuma movimentação registrada.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
